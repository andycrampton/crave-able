<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>craVEable</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#166534">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f8f9f5;
            margin: 0;
            padding-top: env(safe-area-inset-top);
            height: 100dvh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent; 
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M10 10c5 0 10 5 10 10s-5 10-10 10S0 25 0 20s5-10 10-10zm40 40c3 0 6 3 6 6s-3 6-6 6-6-3-6-6 3-6 6-6zM80 20c4 0 8 4 8 8s-4 8-8 8-8-4-8-8 4-8 8-8zM30 80c5 0 10 5 10 10s-5 10-10 10-10-5-10-10 5-10 10-10z' fill='%23d1dcc5' fill-opacity='0.15' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        #app { height: 100%; display: flex; flex-direction: column; }
        .glass-card { background: rgba(255, 255, 255, 0.94); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.7); box-shadow: 0 10px 40px rgba(77, 124, 15, 0.08); }
        .shimmer { background: linear-gradient(90deg, #f0f4e8 25%, #e2e8d5 50%, #f0f4e8 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .brand-green { color: #166534; }
        .bg-brand-green { background-color: #166534; }
        .input-box { background: #ffffff; border: 2px solid #e2e8d5; border-radius: 1.25rem; padding: 1rem; width: 100%; font-size: 1rem; transition: all 0.2s; }
        .input-box:focus { border-color: #166534; outline: none; box-shadow: 0 0 0 4px rgba(22, 101, 52, 0.05); }
        @keyframes popIn { from { opacity: 0; transform: scale(0.97); } to { opacity: 1; transform: scale(1); } }
        .animate-pop { animation: popIn 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        #bmc-wbtn { transform: scale(0.8); bottom: 18px !important; right: 18px !important; }
    </style>
</head>
<body class="text-neutral-800 text-sm">

    <div id="app">
        <header class="p-4 pt-10 flex items-center justify-between z-50">
            <div class="flex items-center gap-3">
                <div class="w-11 h-11 bg-brand-green rounded-2xl flex items-center justify-center shadow-lg transform rotate-3">
                    <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.4 20 4c1 1 2 5 2 10 0 4.4-4.5 6-11 6z"/><path d="M9 21c0-5 2-7 5-7"/></svg>
                </div>
                <h1 class="text-2xl font-black brand-green">cra<span class="text-lime-500">VE</span>able</h1>
            </div>
            <button id="back-btn" onclick="showSearch()" class="hidden bg-white px-5 py-2 rounded-xl border border-neutral-200 font-bold shadow-sm">Back</button>
        </header>

        <main id="search-view" class="flex-1 overflow-y-auto p-4 space-y-6 pb-56">
            <div class="flex bg-lime-100/50 p-1 rounded-2xl border border-lime-200/50">
                <button id="tab-venue" onclick="setMode('venue')" class="flex-1 py-2 text-[11px] font-black uppercase rounded-xl transition-all bg-white text-brand-green shadow-sm">UK Locations</button>
                <button id="tab-dish" onclick="setMode('dish')" class="flex-1 py-2 text-[11px] font-black uppercase rounded-xl transition-all text-lime-800/60">Dish Finder</button>
            </div>

            <section id="venue-inputs" class="glass-card p-6 rounded-[2.5rem] space-y-4 animate-pop">
                <p class="text-[10px] text-lime-800 font-black uppercase tracking-widest">Find Places</p>
                <div class="flex gap-2">
                    <input id="venue-loc-input" type="text" placeholder="Town or Postcode..." class="input-box">
                    <button onclick="performVenueSearch()" class="bg-brand-green text-white px-6 rounded-2xl font-black uppercase shadow-lg active:scale-95 transition-transform">Go</button>
                </div>
            </section>

            <section id="dish-inputs" class="hidden glass-card p-6 rounded-[2.5rem] space-y-4 animate-pop">
                <p class="text-[10px] text-lime-800 font-black uppercase tracking-widest">Find a craving</p>
                <input id="dish-query" type="text" placeholder="e.g. Vegan Roast..." class="input-box">
                <div class="flex gap-2">
                    <input id="dish-loc" type="text" placeholder="UK Town..." class="input-box">
                    <button onclick="performDishSearch()" class="bg-brand-green text-white px-6 rounded-2xl font-black uppercase shadow-lg">Find</button>
                </div>
            </section>

            <div id="loader" class="hidden space-y-4">
                <div class="h-32 w-full rounded-[2.5rem] shimmer"></div>
                <div class="h-32 w-full rounded-[2.5rem] shimmer"></div>
            </div>
            <div id="results-list" class="grid gap-4"></div>
        </main>

        <main id="chat-view" class="hidden flex-1 flex flex-col overflow-hidden bg-white/40">
            <div id="chat-header" class="p-4 bg-white/80 border-b border-lime-100"></div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar"></div>
            <div class="p-4 bg-white border-t border-lime-100 pb-56">
                <form id="chat-form" class="flex gap-2">
                    <input id="chat-input" type="text" autocomplete="off" placeholder="Ask about vegan options..." class="input-box">
                    <button type="submit" class="bg-brand-green text-white px-6 rounded-2xl font-bold active:scale-95 transition-transform">Send</button>
                </form>
            </div>
        </main>

        <footer class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md p-4 pb-12 flex flex-col items-center gap-4 border-t border-black/5 z-[100]">
            <button onclick="showInstallInstructions()" class="text-[10px] font-black uppercase tracking-widest text-lime-800 opacity-60 flex items-center gap-2">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M12 5v14M5 12l7 7 7-7"/></svg>
                Add to Home Screen
            </button>
        </footer>
    </div>

    <script>
        const apiKey = "AIzaSyDyPB-bmAlpzEYte0rlhFY0X_m6og8iNmE"; 
        let activeVenue = null;

        function setMode(m) {
            document.getElementById('tab-venue').className = m==='venue' ? 'flex-1 py-2 text-[11px] font-black uppercase rounded-xl bg-white text-brand-green shadow-sm' : 'flex-1 py-2 text-[11px] font-black uppercase rounded-xl text-lime-800/60';
            document.getElementById('tab-dish').className = m==='dish' ? 'flex-1 py-2 text-[11px] font-black uppercase rounded-xl bg-white text-brand-green shadow-sm' : 'flex-1 py-2 text-[11px] font-black uppercase rounded-xl text-lime-800/60';
            document.getElementById('venue-inputs').classList.toggle('hidden', m!=='venue');
            document.getElementById('dish-inputs').classList.toggle('hidden', m!=='dish');
            document.getElementById('results-list').innerHTML = '';
        }

        async function fetchWithRetry(url, options, retries = 5) {
            let delay = 1000;
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(url, options);
                    if (res.ok) return res;
                    if (res.status === 429 || res.status >= 500) {
                        await new Promise(r => setTimeout(r, delay));
                        delay *= 2;
                        continue;
                    }
                    throw new Error(`Status ${res.status}`);
                } catch (err) {
                    if (i === retries - 1) throw err;
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2;
                }
            }
        }

        async function executeSearch(query) {
            const list = document.getElementById('results-list');
            const loader = document.getElementById('loader');
            list.innerHTML = '';
            loader.classList.remove('hidden');

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const res = await fetchWithRetry(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `${query}. Please list exactly 8 restaurants. Format each line strictly as: Name | Category | Address | One-sentence description.` }] }],
                        tools: [{ "google_search": {} }],
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                        ]
                    })
                });

                const data = await res.json();
                
                if (data.candidates && data.candidates[0].finishReason === "SAFETY") {
                    throw new Error("SAFETY_BLOCK");
                }

                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                const lines = text.split('\n').filter(l => l.includes('|'));

                if (lines.length === 0) throw new Error("NO_RESULTS");

                lines.forEach(line => {
                    const parts = line.split('|').map(p => p.trim());
                    if(parts.length < 3) return;
                    const name = parts[0].replace(/^[\d\.\s-]+/, '');
                    const card = document.createElement('div');
                    card.className = "glass-card p-6 rounded-[2.5rem] animate-pop cursor-pointer active:scale-95 transition-transform";
                    card.onclick = () => startChat({ name, category: parts[1], location: parts[2] });
                    card.innerHTML = `<h3 class="font-bold text-lg brand-green leading-tight">${name}</h3><p class="text-lime-600 text-[9px] font-black uppercase mb-2">${parts[1]} â€¢ ${parts[2]}</p><p class="text-neutral-500 text-xs line-clamp-3">${parts[3] || ''}</p>`;
                    list.appendChild(card);
                });
            } catch (e) {
                let msg = "Something went wrong. Please try again.";
                if (e.message === "SAFETY_BLOCK") msg = "Search filtered for safety. Try being more specific.";
                if (e.message === "NO_RESULTS") msg = "No restaurants found for that area.";
                list.innerHTML = `<div class="p-10 text-center text-red-800/40 font-bold uppercase text-[10px]">${msg}</div>`;
            } finally {
                loader.classList.add('hidden');
            }
        }

        function performVenueSearch() {
            const val = document.getElementById('venue-loc-input').value;
            if(val) executeSearch(`Find high-quality vegan-friendly restaurants in ${val}, UK.`);
        }

        function performDishSearch() {
            const d = document.getElementById('dish-query').value;
            const l = document.getElementById('dish-loc').value;
            if(d && l) executeSearch(`Find restaurants serving ${d} in ${l}, UK. Ensure they have vegan options.`);
        }

        function startChat(v) {
            activeVenue = v;
            document.getElementById('search-view').classList.add('hidden');
            document.getElementById('chat-view').classList.remove('hidden');
            document.getElementById('back-btn').classList.remove('hidden');
            document.getElementById('chat-header').innerHTML = `<h2 class="font-black brand-green uppercase text-sm">${v.name}</h2><p class="text-[9px] text-lime-600 font-bold uppercase">${v.location}</p>`;
            document.getElementById('chat-messages').innerHTML = '';
            addMsg("ai", `Searching for the current menu at <b>${v.name}</b>. What can I find for you?`);
        }

        async function handleChat(userText) {
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const res = await fetchWithRetry(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `User is asking about ${activeVenue.name} at ${activeVenue.location}. Question: ${userText}` }] }],
                        tools: [{ "google_search": {} }],
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" }
                        ]
                    })
                });
                const data = await res.json();
                addMsg("ai", data.candidates?.[0]?.content?.parts?.[0]?.text || "I couldn't find specific details for that request.");
            } catch (e) {
                addMsg("ai", "Connection reset. Please try your question again.");
            }
        }

        function addMsg(r, t) {
            const box = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `flex ${r==='user'?'justify-end':'justify-start'} animate-pop`;
            div.innerHTML = `<div class="${r==='user'?'bg-brand-green text-white rounded-tr-none':'bg-white border border-lime-100 rounded-tl-none'} p-4 rounded-2xl text-xs shadow-sm max-w-[85%]">${t}</div>`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        document.getElementById('chat-form').onsubmit = (e) => {
            e.preventDefault();
            const i = document.getElementById('chat-input');
            const val = i.value.trim();
            if(!val) return;
            addMsg("user", val);
            handleChat(val);
            i.value = '';
        }

        function showSearch() {
            document.getElementById('search-view').classList.remove('hidden');
            document.getElementById('chat-view').classList.add('hidden');
            document.getElementById('back-btn').classList.add('hidden');
        }

        function showInstallInstructions() {
            const modal = document.createElement('div');
            modal.className = "fixed inset-0 bg-black/70 backdrop-blur-sm z-[300] flex items-center justify-center p-6 animate-pop";
            modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
            modal.innerHTML = `<div class="bg-white rounded-[2.5rem] p-8 max-w-xs w-full text-center space-y-4 shadow-2xl"><h3 class="font-black brand-green text-xl">Add to Phone</h3><p class="text-neutral-500 text-sm">Open in your browser's menu and select 'Add to Home Screen'.</p><button onclick="this.parentElement.parentElement.remove()" class="w-full bg-brand-green text-white py-4 rounded-2xl font-bold">Got it</button></div>`;
            document.body.appendChild(modal);
        }
    </script>
    <script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="craveable" data-description="Support craVEable!" data-message="Help keep craVEable alive with a small coffee!" data-color="#5F7FFF" data-position="Right" data-x_margin="18" data-y_margin="18"></script>
</body>
</html>
