<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>craVEable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background-color: #f8f9f5; margin: 0; height: 100dvh; overflow: hidden; }
        #app { height: 100dvh; display: flex; flex-direction: column; position: relative; }
        .scroll-area { flex: 1; overflow-y: auto; padding-bottom: 220px; -webkit-overflow-scrolling: touch; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .brand-green { color: #166534; }
        .bg-brand-green { background-color: #166534; }
        .shimmer { background: linear-gradient(90deg, #f0f4e8 25%, #e2e8d5 50%, #f0f4e8 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body>
    <div id="app">
        <header class="p-6 flex items-center justify-between z-50">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-brand-green rounded-xl flex items-center justify-center shadow-lg transform rotate-2">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.4 20 4c1 1 2 5 2 10 0 4.4-4.5 6-11 6zM9 21c0-5 2-7 5-7"/></svg>
                </div>
                <h1 class="text-xl font-black brand-green uppercase tracking-tighter">cra<span class="text-lime-500">VE</span>able</h1>
            </div>
            <button id="close-chat" onclick="showSearch()" class="hidden bg-white px-4 py-2 rounded-lg text-xs font-bold border shadow-sm">Back</button>
        </header>

        <div class="scroll-area">
            <main id="search-view" class="p-4 space-y-4">
                <div class="flex bg-lime-100/50 p-1 rounded-2xl">
                    <button id="tab-venue" onclick="setMode('venue')" class="flex-1 py-2 text-[10px] font-black uppercase rounded-xl bg-white text-brand-green shadow-sm">Location</button>
                    <button id="tab-dish" onclick="setMode('dish')" class="flex-1 py-2 text-[10px] font-black uppercase rounded-xl text-lime-800/60">Dish Finder</button>
                </div>

                <div id="venue-inputs" class="glass-card p-5 rounded-[2rem] space-y-3 shadow-sm border-2 border-white">
                    <input id="venue-loc-input" type="text" placeholder="Enter town or postcode..." class="w-full border-2 border-lime-50 px-4 py-3 rounded-xl focus:outline-none focus:border-brand-green transition-colors">
                    <button onclick="performVenueSearch()" class="w-full bg-brand-green text-white py-4 rounded-xl font-black uppercase text-sm shadow-md active:scale-[0.98] transition-all">Find Vegan Spots</button>
                </div>

                <div id="dish-inputs" class="hidden glass-card p-5 rounded-[2rem] space-y-3 shadow-sm border-2 border-white">
                    <input id="dish-query" type="text" placeholder="What are you craving? (e.g. Pizza)" class="w-full border-2 border-lime-50 px-4 py-3 rounded-xl focus:outline-none focus:border-brand-green">
                    <input id="dish-loc" type="text" placeholder="Where? (e.g. Leeds)" class="w-full border-2 border-lime-50 px-4 py-3 rounded-xl focus:outline-none focus:border-brand-green">
                    <button onclick="performDishSearch()" class="w-full bg-brand-green text-white py-4 rounded-xl font-black uppercase text-sm shadow-md active:scale-[0.98] transition-all">Find Dish</button>
                </div>

                <div id="loader" class="hidden space-y-3">
                    <div class="h-28 w-full rounded-3xl shimmer"></div>
                    <div class="h-28 w-full rounded-3xl shimmer"></div>
                </div>
                <div id="results-list" class="space-y-3"></div>
            </main>

            <main id="chat-view" class="hidden p-4 space-y-4">
                <div id="chat-header-info" class="mb-2"></div>
                <div id="chat-messages" class="space-y-4 pb-20"></div>
                <div class="fixed bottom-44 left-4 right-4 flex gap-2 z-40">
                    <input id="chat-input" type="text" placeholder="Ask about their menu..." class="flex-1 glass-card px-5 py-4 rounded-2xl focus:outline-none shadow-xl border-brand-green/20 border">
                    <button onclick="sendChat()" class="bg-brand-green text-white p-4 rounded-2xl shadow-xl">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                    </button>
                </div>
            </main>
        </div>

        <footer style="position: fixed; bottom: 0; left: 0; right: 0; background: rgba(248, 249, 245, 0.98); backdrop-filter: blur(15px); padding: 15px 0 calc(25px + env(safe-area-inset-bottom)); display: flex; flex-direction: column; align-items: center; gap: 10px; border-top: 1px solid rgba(0,0,0,0.05); z-index: 100;">
            <button onclick="alert('Tap Share > Add to Home Screen')" class="text-[10px] font-black uppercase text-lime-800 opacity-60 flex items-center gap-2 tracking-widest">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M12 5v14M5 12l7 7 7-7"/></svg>
                Download craVEable
            </button>
            <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="craveable" data-color="#40DCA5" data-emoji="" data-font="Lato" data-text="Support App" data-outline-color="#000000" data-font-color="#ffffff" data-coffee-color="#FFDD00"></script>
        </footer>
    </div>

    <script>
        // CRITICAL FIX: The key below uses a CAPITAL "I" as required by Google
        const apiKey = "AIzaSyClBK14WwHetfsnl-IZM3zMzg81qbVYtbU";
        let activeVenue = null;

        function setMode(mode) {
            document.getElementById('venue-inputs').classList.toggle('hidden', mode !== 'venue');
            document.getElementById('dish-inputs').classList.toggle('hidden', mode !== 'dish');
            document.getElementById('tab-venue').className = mode === 'venue' ? 'flex-1 py-2 text-[10px] font-black uppercase rounded-xl bg-white text-brand-green shadow-sm' : 'flex-1 py-2 text-[10px] font-black uppercase rounded-xl text-lime-800/60';
            document.getElementById('tab-dish').className = mode === 'dish' ? 'flex-1 py-2 text-[10px] font-black uppercase rounded-xl bg-white text-brand-green shadow-sm' : 'flex-1 py-2 text-[10px] font-black uppercase rounded-xl text-lime-800/60';
        }

        async function executeSearch(query) {
            const list = document.getElementById('results-list');
            const loader = document.getElementById('loader');
            list.innerHTML = ''; 
            loader.classList.remove('hidden');
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: query + ". List 10 real results. Format exactly as: Name | Type | Address | Summary" }] }] })
                });
                const data = await response.json();
                
                if (data.error) throw new Error(data.error.message);

                const text = data.candidates[0].content.parts[0].text;
                const lines = text.split('\n').filter(l => l.includes('|'));
                
                lines.forEach(line => {
                    const [name, type, addr, desc] = line.split('|').map(s => s.trim());
                    const card = document.createElement('div');
                    card.className = "glass-card p-6 rounded-[2.5rem] shadow-sm active:scale-95 transition-transform cursor-pointer border-2 border-white mb-4";
                    card.onclick = () => startChat({ name, type, addr, desc });
                    card.innerHTML = `
                        <h3 class="font-bold brand-green text-lg leading-tight">${name}</h3>
                        <p class="text-[10px] font-black text-lime-600 uppercase mt-1 mb-2 tracking-wide">${type} â€¢ ${addr}</p>
                        <p class="text-xs text-neutral-600 leading-relaxed">${desc}</p>
                    `;
                    list.appendChild(card);
                });
            } catch (e) { 
                list.innerHTML = `<div class="p-10 text-center opacity-40 text-xs font-bold leading-relaxed">${e.message.includes('API_KEY') ? 'API Key Error: Please check capitalisation.' : 'Connection error. Please try again.'}</div>`; 
            } finally { loader.classList.add('hidden'); }
        }

        function performVenueSearch() { executeSearch("Find 10 vegan bars and restaurants in " + document.getElementById('venue-loc-input').value); }
        function performDishSearch() { executeSearch("Find 10 places serving " + document.getElementById('dish-query').value + " in " + document.getElementById('dish-loc').value); }

        function startChat(venue) {
            activeVenue = venue;
            document.getElementById('search-view').classList.add('hidden');
            document.getElementById('chat-view').classList.remove('hidden');
            document.getElementById('close-chat').classList.remove('hidden');
            document.getElementById('chat-header-info').innerHTML = `<div class="px-2"><h2 class="font-black brand-green text-xl">${venue.name}</h2><p class="text-[10px] opacity-60 uppercase font-bold tracking-widest">${venue.addr}</p></div>`;
            document.getElementById('chat-messages').innerHTML = '';
            addMsg("ai", `Hi! I'm your AI assistant for ${venue.name}. What can I help you find on their menu?`);
        }

        function showSearch() {
            document.getElementById('search-view').classList.remove('hidden');
            document.getElementById('chat-view').classList.add('hidden');
            document.getElementById('close-chat').classList.add('hidden');
        }

        async function sendChat() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;
            addMsg("user", text);
            input.value = '';
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `You are an assistant for ${activeVenue.name}. User says: ${text}` }] }] })
                });
                const data = await response.json();
                addMsg("ai", data.candidates[0].content.parts[0].text);
            } catch (e) { addMsg("ai", "I'm having trouble connecting right now."); }
        }

        function addMsg(role, text) {
            const box = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-in fade-in slide-in-from-bottom-2`;
            div.innerHTML = `<div class="${role === 'user' ? 'bg-brand-green text-white rounded-tr-none' : 'bg-white border-2 border-lime-50 rounded-tl-none'} p-5 rounded-[2rem] text-xs max-w-[85%] shadow-sm leading-relaxed">${text}</div>`;
            box.appendChild(div);
            const scrollContainer = document.querySelector('.scroll-area');
            scrollContainer.scrollTo({ top: scrollContainer.scrollHeight, behavior: 'smooth' });
        }
    </script>
</body>
</html>
